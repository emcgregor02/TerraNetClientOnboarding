<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TerraNet Orders Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: #f5f5f7;
      color: #111827;
    }
    header {
      background: #101230;
      color: #fff;
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 22px;
    }
    header .sub {
      font-size: 13px;
      opacity: 0.75;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-primary {
      background: #4DBB7F;
      color: white;
      font-weight: 600;
    }
    .btn-primary:hover {
      filter: brightness(0.95);
    }
    main {
      padding: 24px 32px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead {
      background: #f3f4f6;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      font-weight: 600;
      font-size: 13px;
      color: #4b5563;
    }
    tbody tr:hover {
      background: #f9fafb;
    }
    .muted {
      color: #6b7280;
      font-size: 12px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #ecfdf3;
      color: #166534;
      font-weight: 600;
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>TerraNet Orders</h1>
    <div class="sub">Internal dashboard · local HQ server</div>
  </div>
  <button class="btn btn-primary" onclick="goToQuoteBuilder()">New Quote</button>
</header>

<main>
  <div class="card">
    <table>
      <thead>
      <tr>
        <th>Quote ID</th>
        <th>Grower</th>
        <th>Program</th>
          <th>Status</th>
        <th>Fields</th>
        <th>Acres</th>
        <th>Annual Total</th>
        <th>Created</th>
          <th>Actions</th>
      </tr>
      </thead>
      <tbody id="orders-body">
      <tr><td colspan="7" class="muted">Loading orders…</td></tr>
      </tbody>
    </table>
  </div>
</main>

<script>
  async function fetchOrders() {
    const tbody = document.getElementById('orders-body');
    tbody.innerHTML = '<tr><td colspan="7" class="muted">Loading orders…</td></tr>';

    try {
      const res = await fetch('http://127.0.0.1:8000/orders');
      if (!res.ok) {
        tbody.innerHTML = '<tr><td colspan="7" class="muted">Failed to load orders.</td></tr>';
        return;
      }

      const data = await res.json();
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="muted">No orders yet. Create a new quote to get started.</td></tr>';
        return;
      }

      tbody.innerHTML = '';
            data.forEach(order => {
        const tr = document.createElement('tr');

        const programLabel = order.program_type === 'SPRAYER_PLUS_REMOTE'
          ? 'Sprayer + Remote'
          : 'Remote-only';

        const created = new Date(order.created_at).toLocaleString();

        // simple inline color for status
        let statusStyle = 'background:#e5e7eb;color:#374151;'; // default gray
        if (order.status === 'Quoted') {
          statusStyle = 'background:#e0f2fe;color:#0369a1;';
        } else if (order.status === 'Awaiting Payment') {
          statusStyle = 'background:#fef3c7;color:#92400e;';
        } else if (order.status === 'Paid') {
          statusStyle = 'background:#ecfdf3;color:#166534;';
        } else if (order.status === 'Onboarding Started') {
          statusStyle = 'background:#eef2ff;color:#3730a3;';
        } else if (order.status === 'Completed') {
          statusStyle = 'background:#f3f4f6;color:#4b5563;';
        }

        tr.innerHTML = `
          <td><a href="order.html?quote_id=${order.quote_id}" style="color:#2563eb;text-decoration:none">${order.quote_id}</a></td>
          <td>${order.grower_name}</td>
          <td><span class="pill">${programLabel}</span></td>
          <td><span class="pill" style="${statusStyle}">${order.status}</span></td>
          <td>${order.field_count}</td>
          <td>${order.total_acres.toFixed ? order.total_acres.toFixed(1) : order.total_acres}</td>
          <td>$${order.total_annual_cost.toFixed ? order.total_annual_cost.toFixed(2) : order.total_annual_cost}</td>
          <td class="muted">${created}</td>
          <td> <button class="btn" onclick="deleteOrder('${order.quote_id}')">Delete</button> </td>
        `;

        tbody.appendChild(tr);
      });

    } catch (err) {
      console.error('Error loading orders:', err);
      tbody.innerHTML = '<tr><td colspan="7" class="muted">Error loading orders (see console).</td></tr>';
    }
  }

  function goToQuoteBuilder() {
    // Assuming dashboard.html lives alongside TCV_V1.html in /frontend
    window.location.href = 'TCV_V1.html';
  }

  fetchOrders();
    async function deleteOrder(quoteId) {
  if (!confirm(`Delete order ${quoteId}? This cannot be undone.`)) return;

  try {
    const res = await fetch(`http://127.0.0.1:8000/orders/${quoteId}`, {
      method: "DELETE"
    });
    if (!res.ok) {
      alert("Failed to delete order.");
      return;
    }
    await fetchOrders(); // reload table
  } catch (err) {
    console.error("Error deleting order:", err);
    alert("Error deleting order. See console.");
  }
}

</script>
</body>
</html>
