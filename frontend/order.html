<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Details</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f7;
    }
    header {
      background: #101230;
      color: white;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }
    .section-title {
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 18px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      padding: 6px 10px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
    }
    th {
      text-align: left;
      background: #f3f4f6;
      color: #333;
    }
    .label {
      font-size: 13px;
      font-weight: 600;
      color: #4b5563;
    }
    .value {
      font-size: 14px;
      margin-bottom: 8px;
    }
    .export-link {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: #2563eb;
      text-decoration: none;
    }
  </style>
</head>

<body>

<header>
  <h1 id="header-title">Order Details</h1>
  <button onclick="goBack()" style="padding:8px 16px;border-radius:8px;border:none;background:#4DBB7F;color:white;font-weight:600;cursor:pointer">
    Back to Dashboard
  </button>
</header>

<main style="padding: 24px 32px; max-width: 900px; margin:auto;">

  <div id="order-container">Loading orderâ€¦</div>

</main>

<script>
  function getQueryParam(key) {
    const params = new URLSearchParams(window.location.search);
    return params.get(key);
  }

  async function loadOrder() {
    const quoteId = getQueryParam("quote_id");
    if (!quoteId) {
      document.getElementById('order-container').innerHTML = "Quote ID not provided.";
      return;
    }

    document.getElementById("header-title").innerText = `Order: ${quoteId}`;

    try {
      const res = await fetch(`http://127.0.0.1:8000/orders/${quoteId}`);
      if (!res.ok) {
        document.getElementById('order-container').innerHTML = "Order not found.";
        return;
      }

      const order = await res.json();
      renderOrder(order);

    } catch (err) {
      console.error(err);
      document.getElementById('order-container').innerHTML = "Error loading order.";
    }
  }

  function renderOrder(order) {
    const div = document.getElementById("order-container");

    div.innerHTML = `
      <div class="card">
        <div class="section-title">Grower Information</div>
        <div class="label">Name:</div> <div class="value">${order.grower.name}</div>
        <div class="label">Email:</div> <div class="value">${order.grower.email}</div>
        <div class="label">Farm / Operation:</div> <div class="value">${order.grower.farmName || ''}</div>
        <div class="label">Phone:</div> <div class="value">${order.grower.phone || ''}</div>
        <div class="label">Notes:</div> <div class="value">${order.grower.notes || ''}</div>
      </div>

            <div class="card">
        <div class="section-title">Order Summary</div>
        <div class="label">Program:</div> <div class="value">${order.program_type}</div>
        <div class="label">Created:</div> <div class="value">${new Date(order.created_at).toLocaleString()}</div>
        <div class="label">Fields:</div> <div class="value">${order.fields.length}</div>
        <div class="label">Status:</div>
        <div class="value">
          <select id="status-select">
            ${["Quoted","Awaiting Payment","Paid","Onboarding Started","Completed"].map(s => `
              <option value="${s}" ${s === order.status ? 'selected' : ''}>${s}</option>
            `).join('')}
          </select>
          <button onclick="updateStatus()" style="margin-left:8px;padding:4px 10px;border-radius:6px;border:none;background:#4DBB7F;color:white;font-size:12px;cursor:pointer">
            Update
          </button>
        </div>
      </div>


      <div class="card">
        <div class="section-title">Fields</div>
        <table>
          <thead>
            <tr>
              <th>Field Name</th>
              <th>Acres</th>
              <th>Crop Program</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            ${order.fields.map(f => `
              <tr>
                <td>${f.name}</td>
                <td>${f.acres}</td>
                <td>${f.cropProgram || ''}</td>
                <td>${f.notes || ''}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="section-title">Exports</div>
        <a class="export-link">${order.exports.client_info_csv}</a>
        <a class="export-link">${order.exports.fields_csv}</a>
        <a class="export-link">${order.exports.fields_geojson}</a>
        <a class="export-link">${order.exports.fields_geojson_dir}</a>
      </div>
    `;
  }
    async function updateStatus() {
    const quoteId = getQueryParam("quote_id");
    if (!quoteId) return;

    const select = document.getElementById("status-select");
    const newStatus = select.value;

    try {
      const res = await fetch(`http://127.0.0.1:8000/orders/${quoteId}/status`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });

      if (!res.ok) {
        alert("Failed to update status.");
        return;
      }

      const data = await res.json();
      console.log("Status updated:", data);
      alert("Status updated to: " + data.status);
    } catch (err) {
      console.error("Error updating status:", err);
      alert("Error updating status. See console.");
    }
  }

  function goBack() {
    window.location.href = "dashboard.html";
  }

  loadOrder();
</script>

</body>
</html>
