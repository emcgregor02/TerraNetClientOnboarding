<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Details</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f7;
    }
    header {
      background: #101230;
      color: white;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }
    .section-title {
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 18px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      padding: 6px 10px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
    }
    th {
      text-align: left;
      background: #f3f4f6;
      color: #333;
    }
    .label {
      font-size: 13px;
      font-weight: 600;
      color: #4b5563;
    }
    .value {
      font-size: 14px;
      margin-bottom: 8px;
    }
    .export-link {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: #2563eb;
      text-decoration: none;
    }
    .export-btn {
      display: inline-block;
      margin: 4px 6px 4px 0;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 13px;
      cursor: pointer;
    }
    .export-btn:hover {
      background: #e5e7eb;
    }

  </style>
</head>

<body>

<header>
  <h1 id="header-title">Order Details</h1>
  <button onclick="goBack()" style="padding:8px 16px;border-radius:8px;border:none;background:#4DBB7F;color:white;font-weight:600;cursor:pointer">
    Back to Dashboard
  </button>
</header>

<main style="padding: 24px 32px; max-width: 900px; margin:auto;">

  <div id="order-container">Loading order…</div>

</main>

<script>
  function getQueryParam(key) {
    const params = new URLSearchParams(window.location.search);
    return params.get(key);
  }

  let CURRENT_ORDER = null;

  async function loadOrder() {
    const quoteId = getQueryParam("quote_id");
    if (!quoteId) {
      document.getElementById('order-container').innerHTML = "Quote ID not provided.";
      return;
    }

    document.getElementById("header-title").innerText = `Order: ${quoteId}`;

    try {
      const res = await fetch(`http://127.0.0.1:8000/orders/${quoteId}`);
      if (!res.ok) {
        document.getElementById('order-container').innerHTML = "Order not found.";
        return;
      }

      const order = await res.json();
      renderOrder(order);

    } catch (err) {
      console.error(err);
      document.getElementById('order-container').innerHTML = "Error loading order.";
    }
  }

  function renderOrder(order) {
    CURRENT_ORDER = order;  // ✅ store the actual order object

    const div = document.getElementById("order-container");

    div.innerHTML = `
      <div class="card">
        <div class="section-title">Grower</div>
        <div class="label">Name</div> <div class="value">${order.grower.name}</div>
        <div class="label">Email</div> <div class="value">${order.grower.email}</div>
        <div class="label">Farm</div> <div class="value">${order.grower.farmName || ''}</div>
        <div class="label">Phone</div> <div class="value">${order.grower.phone || ''}</div>
        <div class="label">Notes</div> <div class="value">${order.grower.notes || ''}</div>

        <div style="margin-top:12px;">
          <button
            class="export-btn"
            onclick="startNewQuoteForGrower()"
            style="background:#2563eb;color:white;border-color:#2563eb;"
          >
            Start new quote for this grower
          </button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Order Summary</div>
        <div class="label">Program:</div> <div class="value">${order.program_type}</div>
        <div class="label">Created:</div> <div class="value">${new Date(order.created_at).toLocaleString()}</div>
        <div class="label">Fields:</div> <div class="value">${order.fields.length}</div>
        <div class="label">Status:</div>
        <div class="value">
          <select id="status-select">
            ${["Quoted","Awaiting Payment","Paid","Onboarding Started","Completed"].map(s => `
              <option value="${s}" ${s === order.status ? 'selected' : ''}>${s}</option>
            `).join('')}
          </select>
          <button onclick="updateStatus()" style="margin-left:8px;padding:4px 10px;border-radius:6px;border:none;background:#4DBB7F;color:white;font-size:12px;cursor:pointer">
            Update
          </button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Fields</div>
        <table>
          <thead>
            <tr>
              <th>Field Name</th>
              <th>Acres</th>
              <th>Crop Program</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            ${order.fields.map(f => `
              <tr>
                <td>${f.name}</td>
                <td>${f.acres}</td>
                <td>${f.cropProgram || ''}</td>
                <td>${f.notes || ''}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="section-title">Exports</div>
        <button class="export-btn" onclick="downloadExport('client_info.csv')">
          client_info.csv
        </button>
        <button class="export-btn" onclick="downloadExport('fields.csv')">
          fields.csv
        </button>
        <button class="export-btn" onclick="downloadExport('fields.geojson')">
          fields.geojson
        </button>
        <button class="export-btn" onclick="triggerOnboarding()">
          onboarding_packet.zip
        </button>
      </div>
    `;
  }

  async function updateStatus() {
    const quoteId = getQueryParam("quote_id");
    if (!quoteId) return;

    const select = document.getElementById("status-select");
    const newStatus = select.value;

    try {
      const res = await fetch(`http://127.0.0.1:8000/orders/${quoteId}/status`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });

      if (!res.ok) {
        alert("Failed to update status.");
        return;
      }

      const data = await res.json();
      console.log("Status updated:", data);
      alert("Status updated to: " + data.status);
    } catch (err) {
      console.error("Error updating status:", err);
      alert("Error updating status. See console.");
    }
  }

  function getQuoteId() {
    return getQueryParam("quote_id");
  }

  function downloadExport(filename) {
    const quoteId = getQuoteId();
    if (!quoteId) return;

    const url = `http://127.0.0.1:8000/orders/${quoteId}/download/${filename}`;
    window.location.href = url;
  }

  async function triggerOnboarding() {
    const quoteId = getQuoteId();
    if (!quoteId) return;

    try {
      const res = await fetch(`http://127.0.0.1:8000/orders/${quoteId}/onboarding`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      if (!res.ok) {
        alert("Failed to generate onboarding packet. Check backend logs.");
        return;
      }

      const data = await res.json();
      console.log("Onboarding packet generated:", data);

      alert("Onboarding packet generated successfully.");
      downloadExport("onboarding_packet.zip");

    } catch (err) {
      console.error("Error generating onboarding packet:", err);
      alert("Error generating onboarding packet. See console.");
    }
  }

  function goBack() {
    window.location.href = "dashboard.html";
  }

  function startNewQuoteForGrower() {
    if (!CURRENT_ORDER || !CURRENT_ORDER.grower) {
      alert("No grower info found for this order.");
      return;
    }

    const grower = CURRENT_ORDER.grower;

    try {
      localStorage.setItem("terranet_grower", JSON.stringify({
        name: grower.name || "",
        email: grower.email || "",
        farmName: grower.farmName || "",
        phone: grower.phone || "",
        notes: grower.notes || ""
      }));

      // start with fresh fields
      localStorage.removeItem("terranet_fields");

      if (CURRENT_ORDER.program_type) {
        localStorage.setItem("terranet_program_type", CURRENT_ORDER.program_type);
      }

    } catch (e) {
      console.error("Failed to write grower info to localStorage:", e);
    }

    // No reset=1 → TCV_V1 will restore grower but see no fields
    window.location.href = "TCV_V1.html";
  }

  loadOrder();
</script>


</body>
</html>
